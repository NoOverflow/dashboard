@using Dashboard.Models
@using Dashboard.Models.Widgets
@using Dashboard.Services
@inject WidgetFactoryService WidgetFactory

<div id="container">
    <div id="subcontainer">
        @if ((SettingsPanelVisible || SkipToSettings) && @SelectedWidget != null)
        {
            <DynamicComponent Parameters="@DynamicParameters" Type="@(SelectedWidget.SubSettingsType)" />  
            <button @onclick="OnValidateSettingsClick">Confirm</button>
        } 
        else
        {
            @foreach (var widget in Widgets)
            {
            
                <ul>
                    <li>
                        <div @onclick="@(() => OnAddWidgetClick(widget))">
                            <h1>@(widget.FriendlyName)</h1>
                            <p>@(widget.Description)</p>
                        </div>
                    </li>
                </ul>
            }
        }   
    </div>
</div>

@code {

    [Parameter]
    public Action<WidgetModel, int>? OnAddWidget { get; set; }

    [Parameter]
    public int Index { get; set; }

    [Parameter]
    public bool SkipToSettings { get; set; } = false;

    private bool SettingsPanelVisible = false;

    private WidgetModel SelectedWidget { get; set; }
    private Dictionary<string, object> DynamicParameters = new Dictionary<string, object>();
    private List<WidgetModel> Widgets { get; set; } = new List<WidgetModel>();

    protected override void OnInitialized()
    {
        base.OnInitialized();
        foreach (Type widgetType in WidgetFactory.WidgetsTypesList)
        {
            Widgets.Add((WidgetModel)(Activator.CreateInstance(widgetType)!));
        }
    }

    private void OnAddWidgetClick(WidgetModel widget)
    {
        SelectedWidget = widget;
        DynamicParameters.Add("Widget", widget);
        SettingsPanelVisible = true;
    }

    private void OnValidateSettingsClick()
    {
        OnAddWidget?.Invoke(SelectedWidget, Index);
    }
}
